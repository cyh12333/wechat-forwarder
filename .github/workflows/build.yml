name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # 延长超时时间
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4  # ✅ 使用 v4 版本
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.buildozer
          ~/.android
          ~/.gradle
        key: ${{ runner.os }}-deps-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-deps-
          
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git \
          zip \
          unzip \
          openjdk-11-jdk-headless \
          python3-pip \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libffi-dev \
          libssl-dev
          
    - name: Install Python tools
      run: |
        pip install buildozer cython==0.29.33
        
    - name: Configure Buildozer
      run: |
        # 确保 buildozer.spec 存在
        if [ ! -f "buildozer.spec" ]; then
          buildozer init
        fi
        
        # 更新配置，修复弃用警告
        sed -i "s|^title = .*|title = 微信转发器|" buildozer.spec
        sed -i "s|^package.name = .*|package.name = wechatforwarder|" buildozer.spec
        sed -i "s|^package.domain = .*|package.domain = org.wechat|" buildozer.spec
        sed -i "s|^source.dir = .*|source.dir = .|" buildozer.spec
        sed -i "s|^source.main = .*|source.main = main.py|" buildozer.spec
        sed -i "s|^version = .*|version = 1.0.0|" buildozer.spec
        sed -i "s|^requirements = .*|requirements = python3|" buildozer.spec
        
        # 修复弃用配置：使用新的 p4a 语法
        sed -i "s|^android.bootstrap = .*|# android.bootstrap = webview|" buildozer.spec  # 注释旧配置
        sed -i "s|^android.arch = .*|# android.arch = armeabi-v7a|" buildozer.spec  # 注释旧配置
        grep -q "p4a.bootstrap" buildozer.spec || echo "p4a.bootstrap = webview" >> buildozer.spec
        grep -q "android.archs" buildozer.spec || echo "android.archs = armeabi-v7a" >> buildozer.spec
        
        sed -i "s|^android.permissions = .*|android.permissions = INTERNET, ACCESS_NETWORK_STATE|" buildozer.spec
        sed -i "s|^android.api = .*|android.api = 33|" buildozer.spec
        sed -i "s|^android.minapi = .*|android.minapi = 21|" buildozer.spec
        sed -i "s|^android.sdk = .*|android.sdk = 33|" buildozer.spec
        sed -i "s|^android.ndk = .*|android.ndk = 25b|" buildozer.spec
        
    - name: Build APK with retry
      run: |
        # 重试机制，应对网络问题
        for attempt in {1..3}; do
          echo "构建尝试 #$attempt"
          if buildozer -v android debug; then
            echo "✅ 构建成功！"
            exit 0
          else
            echo "❌ 尝试 $attempt 失败，等待 30 秒后重试..."
            sleep 30
          fi
        done
        echo "❌ 所有重试均失败"
        exit 1
        
    - name: Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v4  # ✅ 使用 v4 版本
      with:
        name: wechat-forwarder-apk
        path: |
          bin/*.apk
          *.apk
        retention-days: 7
        
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          .buildozer/**/*.log
        retention-days: 3